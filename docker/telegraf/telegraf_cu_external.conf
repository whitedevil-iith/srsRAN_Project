#
# Copyright 2021-2025 Software Radio Systems Limited
#
# By using this file, you agree to the terms and conditions set
# forth in the LICENSE file which can be found at the top level of
# the distribution.
#
# Telegraf Configuration for CU (Central Unit) with External Metrics Collection
# This configuration collects all possible metrics from:
# - srsRAN CU via WebSocket
# - cAdvisor for container metrics
# - Node Exporter for host system metrics
#

[agent]
  interval                          = "${TELEGRAF_INPUT_INTERVAL:-1s}"
  flush_interval                    = "${TELEGRAF_OUTPUT_INTERVAL:-1s}"
  metric_buffer_limit               = ${TELEGRAF_BUFFER_LIMIT:-10000}
  hostname                          = "${INFLUXDB3_TESTBED}"
  skip_processors_after_aggregators = false
  quiet                             = ${TELEGRAF_QUIET:-true}
  debug                             = ${TELEGRAF_DEBUG:-false}
  logfile                           = "${TELEGRAF_LOG_FILE:-}"

# =============================================================================
# INPUTS - srsRAN CU Metrics via WebSocket
# =============================================================================

[[inputs.execd]]
  command                     = ["/usr/local/bin/ws_adapter.py"]
  data_format                 = "xpath_json"
  buffer_size                 = "${TELEGRAF_INPUT_BUFFER_SIZE:-1MiB}"
  xpath_native_types          = true
  xpath_allow_empty_selection = true

  # UE Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'ue'"
    metric_selection = "/cells/*/ue_list/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "child::*[not(name()='pci') and not(name()='rnti')]"
    [inputs.execd.xpath.tags]
      pci  = "number(pci)"
      rnti = "number(rnti)"

  # Cell Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'cell'"
    metric_selection = "/cells/*/cell_metrics"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*)]"

  # Event List
  [[inputs.execd.xpath]]
    metric_name      = "'event_list'"
    metric_selection = "/cells/*/event_list/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*)]"

  # OFH cell stats
  [[inputs.execd.xpath]]
    metric_name          = "'ofh'"
    metric_selection     = "/ru/ofh/cells/*"
    timestamp            = "/timestamp"
    timestamp_format     = "2006-01-02T15:04:05.000"
    field_selection      = "descendant::*[not(*) and not(name()='pci')]"
    field_name_expansion = true
    [inputs.execd.xpath.tags]
      pci  = "number(pci)"

  # OFH timing stats
  [[inputs.execd.xpath]]
    metric_name          = "'timing_stats'"
    metric_selection     = "/ru/ofh/timing_stats/*"
    timestamp            = "/timestamp"
    timestamp_format     = "2006-01-02T15:04:05.000"
    field_selection      = "descendant::*[not(*)]"
    field_name_expansion = true

  # CU-CP Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'cu_cp'"
    metric_selection = "/cu-cp"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*) and not(name()='ngaps') and not(name()='rrcs')]"

  # NGAP Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'ngaps'"
    metric_selection = "/cu-cp/ngaps/*/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*) and not(name()='amf_name') and not(name()='pdu_session_management_s-nssai')]"
    field_name_expansion = true
    [inputs.execd.xpath.tags]
      amf_name  = "amf_name"
      snssai    = "pdu_session_management/s-nssai"

  # RRC Metrics
  [[inputs.execd.xpath]]
    metric_name      = "'rrcs'"
    metric_selection = "/cu-cp/rrcs/*/*"
    timestamp        = "/timestamp"
    timestamp_format = "2006-01-02T15:04:05.000"
    field_selection  = "descendant::*[not(*) and not(name()='gnb_du_id')]"
    field_name_expansion = true
     [inputs.execd.xpath.tags]
       gnb_du_id  = "number(gnb_du_id)"

  # Fallback for other metrics
  [[inputs.execd.xpath]]
    metric_name          = "name(.)"
    metric_selection     = "/*[not(name()='timestamp') and not(name()='cells') and not(name()='ru') and not(name()='cu-cp') and not(name()='ngaps') and not(name()='rrcs') and not(name()='internal_') ]"
    timestamp            = "/timestamp"
    timestamp_format     = "2006-01-02T15:04:05.000"
    field_selection      = "descendant::*[not(*)]"
    field_name_expansion = true

# =============================================================================
# INPUTS - cAdvisor Container Metrics
# =============================================================================

[[inputs.prometheus]]
  # Collect container metrics from cAdvisor
  urls = ["${CADVISOR_URL:-http://cadvisor:8080}/metrics"]
  metric_version = 2
  interval = "${TELEGRAF_INPUT_INTERVAL:-1s}"

  # Filter to get only the specific container metrics
  # Uses the TELEGRAF_CONTAINER_NAME environment variable
  namepass = [
    "container_cpu_*",
    "container_memory_*",
    "container_network_*",
    "container_fs_*",
    "container_blkio_*",
    "container_tasks_*",
    "container_start_time_seconds",
    "container_last_seen",
    "machine_cpu_*",
    "machine_memory_*"
  ]

  [inputs.prometheus.tags]
    source = "cadvisor"
    node_type = "cu"

# =============================================================================
# INPUTS - Node Exporter Host Metrics
# =============================================================================

[[inputs.prometheus]]
  # Collect host system metrics from Node Exporter
  urls = ["${NODE_EXPORTER_URL:-http://node-exporter:9100}/metrics"]
  metric_version = 2
  interval = "${TELEGRAF_INPUT_INTERVAL:-1s}"

  # Collect all node exporter metrics
  namepass = [
    # CPU metrics
    "node_cpu_*",
    # Memory metrics
    "node_memory_*",
    # Disk I/O metrics
    "node_disk_*",
    # Filesystem metrics
    "node_filesystem_*",
    # Network metrics
    "node_network_*",
    # System load
    "node_load*",
    # Boot time
    "node_boot_time_seconds",
    # Context switches
    "node_context_switches_total",
    # Entropy
    "node_entropy_*",
    # File descriptors
    "node_filefd_*",
    # Interrupts
    "node_intr_total",
    # Process stats
    "node_procs_*",
    # Scheduling stats
    "node_schedstat_*",
    # Socket stats
    "node_sockstat_*",
    # Softnet
    "node_softnet_*",
    # Time and NTP
    "node_time_*",
    "node_ntp_*",
    # uname info
    "node_uname_info",
    # Vmstat
    "node_vmstat_*"
  ]

  [inputs.prometheus.tags]
    source = "node_exporter"
    node_type = "cu"

# =============================================================================
# INPUTS - Telegraf Internal Metrics
# =============================================================================

[[inputs.internal]]
  # Internal Telegraf metrics for health monitoring
  interval = "${TELEGRAF_INPUT_INTERVAL:-1s}"

# =============================================================================
# OUTPUTS - InfluxDB
# =============================================================================

[[outputs.influxdb_v2]]
  urls              = ["${INFLUXDB3_EXTERNAL_URL}"]
  token             = "${INFLUXDB3_AUTH_TOKEN}"
  organization      = ""
  bucket            = "${INFLUXDB3_BUCKET}"
  content_encoding  = "gzip"
  rate_limit        = "${INFLUXDB3_RATE_LIMIT}"
  rate_limit_period = "${INFLUXDB3_RATE_LIMIT_PERIOD}"
  namedrop          = ["internal_*"] # Ignore internal metrics

# =============================================================================
# OUTPUTS - Health Check Endpoint
# =============================================================================

[[outputs.health]]
  service_address = "http://:9273"
  namepass = ["internal_write"]
  tagpass  = { output = ["influxdb_v2"] }

  [[outputs.health.compares]]
    field  = "metrics_written"
    gt     = 0.0

  [[outputs.health.compares]]
    field  = "metrics_dropped"
    eq     = 0.0

  [[outputs.health.compares]]
    field  = "errors"
    eq     = 0.0

  [[outputs.health.compares]]
    field  = "startup_errors"
    eq     = 0.0

  [[outputs.health.compares]]
    field  = "metrics_rejected"
    eq     = 0.0
